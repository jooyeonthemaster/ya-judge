import { GoogleGenerativeAI } from '@google/generative-ai';

// API í‚¤ í™•ì¸
const apiKey = process.env.NEXT_PUBLIC_GEMINI_API_KEY || '';
//console.log('Gemini API í‚¤ ì¡´ì¬ ì—¬ë¶€:', !!apiKey);

const genAI = new GoogleGenerativeAI(apiKey);

// ëª¨ë“  í”„ë¡¬í”„íŠ¸ì— ì ìš©í•  ì‹œìŠ¤í…œ ì§€ì‹œì‚¬í•­
const SYSTEM_INSTRUCTION = `ë‹¹ì‹ ì€ í•­ìƒ í•œêµ­ì–´ë¡œë§Œ ì‘ë‹µí•´ì•¼ í•©ë‹ˆë‹¤. ì ˆëŒ€ ì˜ì–´ë¡œ ì‘ë‹µí•˜ì§€ ë§ˆì„¸ìš”. JSON ì‘ë‹µì„ í¬í•¨í•œ ëª¨ë“  ì¶œë ¥ì€ ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œë§Œ ì‘ì„±í•˜ì„¸ìš”.`;

export interface Message {
  id: string;
  user: 'user-general' | 'judge' | 'system';
  name: string;
  text: string;
  timestamp: string;
  sender?: {
    id: string;
    username: string;
  };
  messageType?: 'normal' | 'evidence' | 'objection' | 'question' | 'closing';
  relatedIssue?: string;
  stage?: string;
}

// ê°œì… ìœ í˜• ì •ì˜
export type InterventionType = 'issue' | 'warning' | 'regulation' | 'evidence' | 'summary' | 'verdict';

// ê°œì… ë°ì´í„° ì¸í„°í˜ì´ìŠ¤
export interface InterventionData {
  shouldIntervene: boolean;
  interventionType?: InterventionType;
  interventionMessage?: string;
  detectedIssues?: string[];
  userToneAnalysis?: Record<string, string>;
  evidenceRequest?: {
    targetUser: string;
    claim: string;
    requestReason: string;
  };
  targetUser?: string; // íŠ¹ì • ì‚¬ìš©ì ëŒ€ìƒ ë©”ì‹œì§€
}

// ì‹¤ì‹œê°„ ëŒ€í™” ë¶„ì„ í•¨ìˆ˜
export const analyzeConversation = async (
  messages: Message[],
  previousInterventions: {
    id: string;
    type: InterventionType;
    timestamp: string;
    text: string;
    targetUser?: string;
  }[],
  detectedIssues: string[]
): Promise<InterventionData> => {
  if (!apiKey) {
    console.error('Gemini API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
    return { shouldIntervene: false };
  }
  
  try {
    // ë©”ì‹œì§€ê°€ ë„ˆë¬´ ì ìœ¼ë©´ ê°œì…í•˜ì§€ ì•ŠìŒ
    if (messages.filter(m => m.user === 'user-general').length < 3) {
      //console.log('ëŒ€í™”ê°€ ì¶©ë¶„í•˜ì§€ ì•Šì•„ ë¶„ì„ì„ ê±´ë„ˆëœë‹ˆë‹¤.');
      return { shouldIntervene: false };
    }
    
    //console.log('ì‹¤ì‹œê°„ ëŒ€í™” ë¶„ì„ ì‹œì‘');
    const model = genAI.getGenerativeModel({ model: "gemini-2.0-flash" });
    
    // ì°¸ê°€ì ì •ë³´ ì¶”ì¶œ
    const participants = Array.from(new Set(
      messages
        .filter(msg => msg.user === 'user-general')
        .map(msg => msg.name)
    ));
    
    // ëŒ€í™” ì´ë ¥ êµ¬ì„± (ë°œí™”ì ì •ë³´ì™€ ë°œí™” ì‹œê°„ë„ í¬í•¨)
    const conversationHistory = messages
      .filter(msg => msg.user !== 'system' || msg.text.includes('íŒì‚¬ê°€ ìƒí™©ì„ ë¶„ì„'))
      .map(msg => {
        const timestamp = new Date(msg.timestamp).toLocaleTimeString();
        let prefix = '';
        
        // Role-based prefixes
        if (msg.user === 'judge') {
          prefix = 'íŒì‚¬: ';
        } else if (msg.user === 'system') {
          prefix = 'ì‹œìŠ¤í…œ: ';
        } else {
          prefix = `${msg.name}: `;
        }
        
        // ë©”ì‹œì§€ ìœ í˜• ë° ê´€ë ¨ ìŸì  í‘œì‹œ
        let messagePrefix = '';
        if (msg.messageType === 'evidence') {
          messagePrefix = '[ì¦ê±°] ';
        } else if (msg.messageType === 'objection') {
          messagePrefix = '[ë°˜ë¡ ] ';
        } else if (msg.messageType === 'closing') {
          messagePrefix = '[ìµœì¢…ë³€ë¡ ] ';
        }
        
        if (msg.relatedIssue) {
          messagePrefix += `[ìŸì : ${msg.relatedIssue}] `;
        }
        
        return `${prefix}${messagePrefix}${msg.text}`;
      })
      .join('\n');
    
    // ì´ì „ ê°œì… ê¸°ë¡
    const interventionHistory = previousInterventions
      .map(intervention => {
        const timestamp = new Date(intervention.timestamp).toLocaleTimeString();
        return `[${intervention.type}] íŒì‚¬(${timestamp}): ${intervention.text}`;
      })
      .join('\n');
    
    // ê¸°ì¡´ ê°ì§€ëœ ìŸì ë“¤
    const issuesStr = detectedIssues.length > 0 
      ? `ì´ë¯¸ ê°ì§€ëœ ìŸì ë“¤:\n${detectedIssues.join('\n')}`
      : 'ì•„ì§ ê°ì§€ëœ ìŸì ì´ ì—†ìŠµë‹ˆë‹¤.';

    let prompt = '';
    let stage = 'interview';

    // ì°¸ì—¬ìê°€ ì¶©ë¶„í•œì§€ í™•ì¸
    const uniqueParticipants = new Set(
      messages
        .filter(m => m.user === 'user-general')
        .map(m => m.name)
    );

    // ì´ˆê¸° ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì¶”ê°€
    prompt = `
      ë‹¹ì‹ ì€ í•­ìƒ í•œêµ­ì–´ë¡œë§Œ ì‘ë‹µí•´ì•¼ í•©ë‹ˆë‹¤. ì ˆëŒ€ ì˜ì–´ë¡œ ì‘ë‹µí•˜ì§€ ë§ˆì„¸ìš”.
      
      ë‹¹ì‹ ì€ ëŒ€í™”ë¥¼ ëª¨ë‹ˆí„°ë§í•˜ëŠ” AI íŒì‚¬ì…ë‹ˆë‹¤. 
      ì‚¬ìš©ìë“¤ì˜ ëŒ€í™”ë¥¼ ë¶„ì„í•˜ì—¬ í•„ìš”í•  ë•Œë§Œ ê°œì…í•©ë‹ˆë‹¤.
      ë‹¹ì‹ ì€ ì§ì ‘ ëŒ€í™” ì°¸ì—¬ìê°€ ì•„ë‹ˆë©°, ë©”ì‹œì§€ëŠ” ì‚¬ìš©ìë“¤ ê°„ì˜ ëŒ€í™”ì…ë‹ˆë‹¤.
      ë‹¹ì‹ ì—ê²Œ ì§ì ‘ ë§í•˜ëŠ” ê²ƒì´ ì•„ë‹™ë‹ˆë‹¤.
      
      ë‹¹ì‹ ì€ ì•„ë˜ ë‘ ê°€ì§€ ìƒí™©ì—ì„œë§Œ ê°œì…í•´ì•¼ í•©ë‹ˆë‹¤:
      1. ì‚¬ìš©ìê°€ ìš•ì„¤ì´ë‚˜ ê³µê²©ì  ì–¸ì–´ë¥¼ ì‚¬ìš©í•  ë•Œ
      2. íƒ€ì´ë¨¸ê°€ ì¢…ë£Œë˜ì–´ ìµœì¢… íŒê²°ì„ ë‚´ë ¤ì•¼ í•  ë•Œ
      
      í‰ë²”í•œ ëŒ€í™”ì—ëŠ” ì ˆëŒ€ ê°œì…í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
      
      ëŒ€í™” ë‚´ìš©:
      ${conversationHistory}
      
      ì´ì „ ê°œì… ë‚´ì—­:
      ${interventionHistory || 'ì´ì „ ê°œì… ì—†ìŒ'}
      
      ê°ì§€ëœ ìŸì :
      ${issuesStr}
      
      í˜„ì¬ ëŒ€í™”ë¥¼ ë¶„ì„í•˜ì—¬ ìš•ì„¤ì´ë‚˜ ê³µê²©ì ì¸ í‘œí˜„ì´ ìˆëŠ”ì§€ë§Œ í™•ì¸í•˜ì„¸ìš”.
      ê³µê²©ì  í‘œí˜„ì´ ê°ì§€ë˜ë©´ ê°œì…í•˜ê³ , ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ê°œì…í•˜ì§€ ë§ˆì„¸ìš”.
      
      ìš•ì„¤ì´ ê°ì§€ë˜ë©´ ë°˜ë“œì‹œ ì—„ê²©í•˜ê²Œ ëŒ€ì‘í•´ì•¼ í•©ë‹ˆë‹¤. ìš•ì„¤ ì‚¬ìš©ìì—ê²Œ ì§ì ‘ì ìœ¼ë¡œ ê²½ê³ í•˜ê³ , 
      í•´ë‹¹ ì–¸ì–´ê°€ ì™œ ë¶€ì ì ˆí•œì§€ ë¶„ëª…í•˜ê²Œ ì„¤ëª…í•˜ì„¸ìš”. íŒì‚¬ë¡œì„œ ê¶Œìœ„ìˆëŠ” í†¤ìœ¼ë¡œ ë§í•˜ì„¸ìš”.
      ê³µê²©ì ì¸ ì–¸ì–´ëŠ” ì¦‰ì‹œ ì œì¬í•´ì•¼ í•©ë‹ˆë‹¤. ì´ê²ƒì€ ë ˆë²¨ì´ ì•„ë‹ˆë¼ ì ˆëŒ€ì ì¸ ê·œì¹™ì…ë‹ˆë‹¤.
      
      ì‘ë‹µ í˜•ì‹:
      {
        "shouldIntervene": true/false,
        "interventionType": "warning", 
        "interventionMessage": "ê°œì… ë©”ì‹œì§€ (ìš•ì„¤ì´ ê°ì§€ëœ ê²½ìš° íŒì‚¬ë¡œì„œ ì—„ê²©í•˜ê³  ë‹¨í˜¸í•œ ê²½ê³  ë©”ì‹œì§€)",
        "targetUser": "ë¬¸ì œê°€ ìˆëŠ” ì‚¬ìš©ì ì´ë¦„",
        "detectedIssues": ["ìŸì 1", "ìŸì 2"]
      }
      
      ì°¸ê³ : ê³µê²©ì  ì–¸ì–´ê°€ ë°œê²¬ë˜ì§€ ì•Šìœ¼ë©´ ë°˜ë“œì‹œ shouldInterveneì„ falseë¡œ ì„¤ì •í•˜ì„¸ìš”.
      ê³µê²©ì  ì–¸ì–´ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ë‹¨ì–´ë¥¼ í¬í•¨í•©ë‹ˆë‹¤: ì”¨ë°œ, ê°œìƒˆë¼, ë³‘ì‹ , ë¯¸ì¹œë†ˆ, ë“±
    `;
    
    //console.log('Gemini í”„ë¡¬í¬íŠ¸ ìƒì„± ì™„ë£Œ, API ìš”ì²­ ì‹œì‘');
    
    const result = await model.generateContent(prompt);
    //console.log('Gemini API ì‘ë‹µ ë°›ìŒ');

    // API ì‘ë‹µ ì²˜ë¦¬
    const responseText = result.response.text();
    //console.log('ì‘ë‹µ ê¸¸ì´:', responseText.length);
    
    // 'undefined' ë¬¸ìì—´ ì œê±°
    const cleanedResponse = responseText.replace(/undefined/g, '');
    
    // ì‘ë‹µ ì •ì œ ì‹œë„
    try {
      // ì‘ë‹µì—ì„œ ì‹¤ì œ JSON ë¶€ë¶„ ì¶”ì¶œ
      let cleanedText = cleanedResponse;
      
      // í…ìŠ¤íŠ¸ ì‘ë‹µ ì²˜ë¦¬ (JSON í˜•ì‹ì´ ì•„ë‹Œ ê²½ìš°)
      if (!cleanedText.trim().startsWith("{")) {
        const jsonMatch = cleanedText.match(/(\{[\s\S]*\})/);
        if (jsonMatch && jsonMatch[1]) {
          cleanedText = jsonMatch[1];
        } else {
          // ê¸°ë³¸ì ìœ¼ë¡œ ê°œì…í•˜ì§€ ì•Šë„ë¡ í•¨
          return {
            shouldIntervene: false
          };
        }
      }
      
      // ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡ ì œê±°
      cleanedText = cleanedText.replace(/```json\s*([\s\S]*?)\s*```/g, '$1');
      cleanedText = cleanedText.replace(/```\s*([\s\S]*?)\s*```/g, '$1');
      
      // JSON íŒŒì‹±
      const parsedResponse: InterventionData = JSON.parse(cleanedText);
      //console.log('íŒŒì‹±ëœ ì‘ë‹µ:', JSON.stringify(parsedResponse).substring(0, 200) + '...');
      
      return parsedResponse;
    } catch (parseError) {
      console.error('ì‘ë‹µ íŒŒì‹± ì˜¤ë¥˜:', parseError);
      //console.log('ì›ë³¸ ì‘ë‹µ:', cleanedResponse);
      
      // ì‘ë‹µì´ JSON í˜•ì‹ì´ ì•„ë‹ˆë©´ ê°œì…í•˜ì§€ ì•ŠìŒ
      return {
        shouldIntervene: false
      };
    }
  } catch (error) {
    console.error('Gemini API ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
    return { shouldIntervene: false };
  }
};

export interface PersonalizedResponse {
  targetUser: string;
  analysis: string;
  message: string;
  style: string;
  percentage: number;
  reasoning: string[];
  punishment: string;
}

export interface IssueJudgement {
  issue: string;
  judgement: string;
  reasoning: string;
}

export interface VerdictData {
  responses: PersonalizedResponse[];
  issueJudgements?: IssueJudgement[];
  verdict: {
    summary: string;
    conflict_root_cause: string;
    recommendation: string;
  };
}

export interface IssuesData {
  issues: string[];
  needMoreInfo?: boolean;
  guidanceMessage?: string;
  summary: string;
  judgeMessage: string;
}

export interface DiscussionData {
  analysis: Record<string, string>;
  evidenceRequired: boolean;
  evidenceRequests?: Array<{
    targetUser: string;
    claim: string;
    requestReason: string;
  }>;
  summary: string;
  judgeMessage: string;
}

export interface QuestionsData {
  questions: Array<{
    targetUser: string;
    question: string;
    purpose: string;
  }>;
  summary: string;
  judgeMessage: string;
}

export interface ClosingData {
  summary: string;
  closingInstructions: string;
  judgeMessage: string;
}

export interface JudgeMessageData {
  analysis: Record<string, string>;
  judgeMessage: string;
  nextStep: string;
}

// ë‹¨ê³„ë³„ íŠ¹í™”ëœ íŒì‚¬ ìš”ì²­ í•¨ìˆ˜ë“¤
export const generateIssues = async (messages: Message[]): Promise<IssuesData> => {
  const response = await getJudgeResponse(messages, 'issues');
  try {
    const data = JSON.parse(response) as IssuesData;
    
    // ìŸì  ê°œìˆ˜ë¥¼ ìµœëŒ€ 5ê°œë¡œ ì œí•œ
    if (data.issues && data.issues.length > 5) {
      //console.log(`ìŸì  ì„ ë³„ í•„ìš”: ${data.issues.length}ê°œ ìŸì  ë°œê²¬`);
      
      // ì£¼ìš” ìŸì  ì„ ë³„ ë¡œì§
      const selectedIssues = selectImportantIssues(data.issues, messages);
      data.issues = selectedIssues;
      
      //console.log(`ì„ ë³„ëœ ì£¼ìš” ìŸì  ${selectedIssues.length}ê°œ`);
    }
    
    // ìœ íš¨í•˜ì§€ ì•Šì€ ìŸì  í•„í„°ë§
    if (data.issues && data.issues.length > 0) {
      // ìœ íš¨í•˜ì§€ ì•Šì€ íŒ¨í„´ ì •ì˜
      const invalidPatterns = [
        /ìŸì ì„ ì°¾ê¸°/i,
        /ì •ë³´ê°€ ë¶€ì¡±/i,
        /ìŸì ì— ë™ì˜/i,
        /ë‹¤ìŒ ë‹¨ê³„/i,
        /í™•ì¸ í•„ìš”/i,
        /ì„œë¡œ ëŒ€í™”ê°€ í•„ìš”í•´ìš”/i,
        /ì„œë¡œ ì¡´ì¤‘í•´ì•¼ í•´ìš”/i,
        /ì•ˆ\s*ë©ë‹ˆë‹¤/i,   // í•´ì„ì´ í¬í•¨ëœ ë¬¸ì¥ ì œì™¸
        /í›„ë¦‰í•˜ì§€ë§Œ/i,
        /ì•„ë‹™ë‹ˆë‹¤/i,
        /ëª¨ë¦…ë‹ˆë‹¤/i,
        /ë˜ì—ˆìŠµë‹ˆë‹¤/i
      ];
      
      // í•´ë‹¹ íŒ¨í„´ì´ í¬í•¨ëœ ìŸì  ì œê±°
      data.issues = data.issues.filter(issue => {
        return !invalidPatterns.some(pattern => pattern.test(issue));
      });
      
      // ë¬¸ì¥ ë‹¨ìœ„ë¡œ ë¶„ë¦¬ëœ ê²½ìš° ì²˜ë¦¬ ì¶”ê°€
      if (data.issues.length === 1 && data.issues[0].includes('.')) {
        // ë¬¸ì¥ ë‹¨ìœ„ë¡œ ë¶„ë¦¬í•˜ì—¬ ìŸì  ì¶”ì¶œ
        const sentences = data.issues[0].split(/(?<=\.)\s+/);
        
        // ì‹¤ì œ ìŸì ë§Œ ì¶”ì¶œ (ê°ê´€ì ì¸ ë‚´ìš©ë§Œ)
        const validIssues = sentences.filter(sentence => {
          // íŒë‹¨ì´ë‚˜ í•´ì„ì´ í¬í•¨ëœ ë¬¸ì¥ ì œì™¸
          if (/ì•ˆ\s*ë©ë‹ˆë‹¤|í›„ë¦‰í•˜ì§€ë§Œ|ì•„ë‹™ë‹ˆë‹¤|ëª¨ë¦…ë‹ˆë‹¤|ë˜ì—ˆìŠµë‹ˆë‹¤/.test(sentence)) {
            return false;
          }
          // ì§€ì‹œì‚¬í•­ì´ë‚˜ ì•ˆë‚´ ë¬¸ì¥ ì œì™¸
          if (/í•´ì•¼\s*í•©ë‹ˆë‹¤|í•„ìš”í•©ë‹ˆë‹¤|ì¤‘ìš”í•©ë‹ˆë‹¤/.test(sentence)) {
            return false;
          }
          return true;
        });
        
        data.issues = validIssues.length > 0 ? validIssues : ["**ê´€ê³„ ê°ˆë“±**ì˜ í•µì‹¬ ìŸì "];
      }
      
      // í•„í„°ë§ í›„ ìŸì ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ ìŸì  ì¶”ê°€
      if (data.issues.length === 0) {
        data.issues = ["**ê´€ê³„ì—ì„œì˜ ì˜ì‚¬ì†Œí†µ ë°©ì‹**ì— ëŒ€í•œ ê²¬í•´ ì°¨ì´"];
      }
    }
    
    // ìŸì  ì •ì œë¥¼ ìœ„í•œ ì¶”ê°€ í˜¸ì¶œ
    data.issues = await refineIssues(data.issues);
    
    return data;
  } catch (error) {
    console.error('Issues ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:', error);
    throw new Error('ìŸì  ì •ë¦¬ ì‘ë‹µì„ ì²˜ë¦¬í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
};

export const refineIssues = async (issues: string[]): Promise<string[]> => {
  if (!apiKey || issues.length === 0) {
    return issues;
  }
  
  try {
    const model = genAI.getGenerativeModel({ model: "gemini-2.0-flash" });
    
    const prompt = `
      ë‹¹ì‹ ì€ ê´€ê³„ ë¬¸ì œì—ì„œ ê°ê´€ì ì¸ ìŸì ë§Œ ì¶”ì¶œí•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
      
      ì•„ë˜ ëª©ë¡ì—ì„œ ì§„ì§œ ê´€ê³„ ìŸì ë§Œ ê°ê´€ì ìœ¼ë¡œ ë‹¤ì‹œ ì‘ì„±í•´ì£¼ì„¸ìš”. ë‹¤ìŒê³¼ ê°™ì€ í•­ëª©ì€ ì œì™¸í•˜ì„¸ìš”:
      - í•´ì„ì´ë‚˜ íŒë‹¨ì´ í¬í•¨ëœ í•­ëª© (ì˜ˆ: "~ì¼ê¹Œìš”?", "~ì•„ë‹ê¹Œìš”?", "~ì´ ì •ë‹¹í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤")
      - ì§€ì‹œì‚¬í•­ì´ë‚˜ ì•ˆë‚´ (ì˜ˆ: "ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰í•˜ì„¸ìš”")
      - ì§„ë¶€í•œ ì¡°ì–¸ (ì˜ˆ: "ì„œë¡œ ëŒ€í™”ê°€ í•„ìš”í•¨", "ì„œë¡œ ì¡´ì¤‘í•´ì•¼ í•¨")
      
      ê° ìŸì ì€ ë‹¤ìŒê³¼ ê°™ì€ í˜•ì‹ìœ¼ë¡œ ê°ê´€ì ìœ¼ë¡œ ë‹¤ì‹œ ì‘ì„±í•´ì£¼ì„¸ìš”:
      - "**í•µì‹¬ ì£¼ì œë‚˜ í–‰ë™** ê´€ë ¨ ê°ˆë“±" (ì˜ˆ: "**ì†Œí†µ ë°©ì‹**ì— ëŒ€í•œ ê²¬í•´ ì°¨ì´")
      
      ê²€í† í•  ëª©ë¡:
      ${issues.join('\n')}
      
      ì‘ë‹µ í˜•ì‹:
      ["ê°ê´€ì  ìŸì 1", "ê°ê´€ì  ìŸì 2", "ê°ê´€ì  ìŸì 3"]
    `;
    
    const result = await model.generateContent(prompt);
    const responseText = result.response.text();
    
    // JSON íŒŒì‹± ì‹œë„
    try {
      // ì‘ë‹µì—ì„œ ì‹¤ì œ JSON ë¶€ë¶„ ì¶”ì¶œ
      const jsonMatch = responseText.match(/(\{[\s\S]*\})/);
      if (jsonMatch && jsonMatch[1]) {
        const refinedIssues = JSON.parse(jsonMatch[1]);
        return refinedIssues.filter(Boolean);
      }
    } catch (parseError) {
      console.error('ìŸì  ì •ì œ JSON íŒŒì‹± ì‹¤íŒ¨:', parseError);
    }
    
    return issues; // íŒŒì‹± ì‹¤íŒ¨ ì‹œ ì›ë³¸ ë°˜í™˜
  } catch (error) {
    console.error('ìŸì  ì •ì œ ì˜¤ë¥˜:', error);
    return issues; // ì˜¤ë¥˜ ì‹œ ì›ë³¸ ë°˜í™˜
  }
};

// ì£¼ìš” ìŸì  ì„ ë³„ í•¨ìˆ˜
function selectImportantIssues(issues: string[], messages: Message[]): string[] {
  // 1. ìŸì  ì¤‘ìš”ë„ í‰ê°€
  const scoredIssues = issues.map(issue => {
    let score = 0;
    
    // ê¸¸ì´ê°€ ì ë‹¹í•œ ìŸì  ìš°ì„  (ë„ˆë¬´ ì§§ê±°ë‚˜ ë„ˆë¬´ ê¸´ ìŸì ì€ ë‚®ì€ ì ìˆ˜)
    if (issue.length > 10 && issue.length < 100) score += 2;
    
    // ê°•ì¡° í‘œì‹œ(ë³¼ë“œ)ê°€ ìˆëŠ” ìŸì  ìš°ì„ 
    if (issue.includes('**')) score += 3;
    
    // ë©”ì‹œì§€ì—ì„œ ì–¸ê¸‰ëœ í•µì‹¬ í‚¤ì›Œë“œë¥¼ í¬í•¨í•˜ëŠ” ìŸì  ìš°ì„ 
    const keywords = extractKeywords(messages);
    keywords.forEach(keyword => {
      if (issue.toLowerCase().includes(keyword.toLowerCase())) {
        score += 2;
      }
    });
    
    // í•´ì„ì´ë‚˜ íŒë‹¨ì´ í¬í•¨ëœ ìŸì ì€ ë‚®ì€ ì ìˆ˜
    if (/ì•ˆ\s*ë©ë‹ˆë‹¤|í›„ë¦‰í•˜ì§€ë§Œ|ì•„ë‹™ë‹ˆë‹¤|ëª¨ë¦…ë‹ˆë‹¤|ë˜ì—ˆìŠµë‹ˆë‹¤/.test(issue)) {
      score -= 5;
    }
    
    return { issue, score };
  });
  
  // 2. ì ìˆ˜ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬
  const sortedIssues = scoredIssues.sort((a: {issue: string, score: number}, b: {issue: string, score: number}) => b.score - a.score);
  
  // 3. ìƒìœ„ 5ê°œ ìŸì  ì„ íƒ
  return sortedIssues.slice(0, 5).map(item => item.issue);
}

// ë©”ì‹œì§€ì—ì„œ í•µì‹¬ í‚¤ì›Œë“œ ì¶”ì¶œ í•¨ìˆ˜
function extractKeywords(messages: Message[]): string[] {
  // ì‚¬ìš©ì ë©”ì‹œì§€ë§Œ ì¶”ì¶œ
  const userMessages = messages.filter(msg => 
    msg.user === 'user-general'
  );
  
  // ë©”ì‹œì§€ í…ìŠ¤íŠ¸ ê²°í•©
  const allText = userMessages.map(msg => msg.text).join(' ');
  
  // ë¶ˆí•„ìš”í•œ ë‹¨ì–´ ë° íŠ¹ìˆ˜ë¬¸ì ì œê±°
  const cleanedText = allText
    .replace(/[^\w\sê°€-í£]/g, ' ')
    .replace(/\s+/g, ' ')
    .toLowerCase();
  
  // ë‹¨ì–´ ë¹ˆë„ìˆ˜ ê³„ì‚°
  const wordCounts: Record<string, number> = {};
  cleanedText.split(' ').forEach(word => {
    if (word.length > 1) { // 2ê¸€ì ì´ìƒ ë‹¨ì–´ë§Œ ì¹´ìš´íŠ¸
      wordCounts[word] = (wordCounts[word] || 0) + 1;
    }
  });
  
  // ë¹ˆë„ìˆ˜ ê¸°ì¤€ ìƒìœ„ 10ê°œ í‚¤ì›Œë“œ ì¶”ì¶œ
  return Object.entries(wordCounts)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 10)
    .map(entry => entry[0]);
}

export const generateDiscussion = async (messages: Message[], currentIssue: string): Promise<DiscussionData> => {
  const response = await getJudgeResponse(messages, 'discussion', currentIssue);
  return JSON.parse(response) as DiscussionData;
};

export const generateQuestions = async (messages: Message[]): Promise<QuestionsData> => {
  const response = await getJudgeResponse(messages, 'questions');
  return JSON.parse(response) as QuestionsData;
};

export const generateClosing = async (messages: Message[]): Promise<ClosingData> => {
  const response = await getJudgeResponse(messages, 'closing');
  return JSON.parse(response) as ClosingData;
};

export const generateVerdict = async (messages: Message[]): Promise<VerdictData> => {
  const response = await getJudgeResponse(messages, 'verdict');
  return JSON.parse(response) as VerdictData;
};

export const generateJudgeMessage = async (messages: Message[], stage: string): Promise<JudgeMessageData> => {
  try {
    const response = await getJudgeResponse(messages, stage);
    //console.log('API ì‘ë‹µ ê²°ê³¼:', response.substring(0, 100) + '...');
    
    // ëª¨ë“  undefined ë¬¸ìì—´ ì œê±°ë¥¼ ì—¬ëŸ¬ íŒ¨í„´ìœ¼ë¡œ ìˆ˜í–‰
    let cleanedResponse = response;
    
    // ì²« ë²ˆì§¸ ì •ì œ: ê¸°ë³¸ undefined ì œê±°
    cleanedResponse = cleanedResponse.replace(/undefined/g, '');
    
    // ë‘ ë²ˆì§¸ ì •ì œ: ë¬¸ì¥ ëì˜ undefined
    cleanedResponse = cleanedResponse.replace(/\. undefined/g, '.');
    cleanedResponse = cleanedResponse.replace(/\.\s*undefined/g, '.');
    
    // ì„¸ ë²ˆì§¸ ì •ì œ: ê³µë°±ê³¼ í•¨ê»˜ ìˆëŠ” undefined
    cleanedResponse = cleanedResponse.replace(/ undefined[.,]?/g, '');
    cleanedResponse = cleanedResponse.replace(/\s+undefined\s*/g, ' ');
    
    // ë„¤ ë²ˆì§¸ ì •ì œ: í…ìŠ¤íŠ¸ ëì˜ undefined
    cleanedResponse = cleanedResponse.replace(/undefined$/g, '');
    cleanedResponse = cleanedResponse.replace(/undefined\s*$/g, '');
    
    // ë‹¤ì„¯ ë²ˆì§¸ ì •ì œ: ì¤„ ì‹œì‘ì˜ undefined
    cleanedResponse = cleanedResponse.replace(/^undefined\s*/gm, '');
    
    // ì—¬ì„¯ ë²ˆì§¸ ì •ì œ: ë¬¸ì ì‚¬ì´ì˜ undefined
    cleanedResponse = cleanedResponse.replace(/([^\s])undefined([^\s])/g, '$1$2');
    
    // ì¼ê³± ë²ˆì§¸ ì •ì œ: ì¶”ê°€ ì •ì œ (ì¤‘ë³µ ê³µë°±ë„ ì •ë¦¬)
    cleanedResponse = cleanedResponse.replace(/\s{2,}/g, ' ').trim();
    
    // ì—¬ëŸ ë²ˆì§¸ ì •ì œ: JSONì— ì˜í–¥ì„ ì£¼ì§€ ì•Šë„ë¡ ì¶”ê°€ íŒ¨í„´ ì ìš©
    cleanedResponse = cleanedResponse.replace(/"([^"]*?)undefined([^"]*?)"/g, '"$1$2"'); // JSON ë¬¸ìì—´ ë‚´ë¶€ì˜ undefined
    cleanedResponse = cleanedResponse.replace(/:\s*undefined\s*([,}])/g, ':null$1'); // JSON ê°’ìœ¼ë¡œì„œì˜ undefined
    
    //console.log('undefined ì œê±° í›„ ì‘ë‹µ:', cleanedResponse.substring(0, 100) + '...');
    
    // JSON íŒŒì‹± ì‹œë„
    const parsed = JSON.parse(cleanedResponse) as JudgeMessageData;
    
    // undefined ê°’ì„ í•„í„°ë§í•˜ëŠ” í•¨ìˆ˜ ì •ì˜
    const removeUndefined = (obj: any): any => {
      if (!obj || typeof obj !== 'object') return obj;
      
      if (Array.isArray(obj)) {
        return obj.map(item => removeUndefined(item)).filter(item => item !== undefined);
      }
      
      const result: any = {};
      for (const key in obj) {
        if (Object.prototype.hasOwnProperty.call(obj, key) && obj[key] !== undefined) {
          result[key] = removeUndefined(obj[key]);
        }
      }
      return result;
    };
    
    // undefined ê°’ í•„í„°ë§ ì ìš©
    const cleanedParsed = removeUndefined(parsed);
    
    // í•„ìˆ˜ í•„ë“œê°€ ì—†ëŠ” ê²½ìš° ê¸°ë³¸ê°’ ì„¤ì •
    if (!cleanedParsed.judgeMessage || typeof cleanedParsed.judgeMessage !== 'string') {
      console.error('judgeMessage ëˆ„ë½ ë˜ëŠ” ì˜ëª»ëœ í˜•ì‹:', cleanedParsed);
      cleanedParsed.judgeMessage = 'í˜„ì¬ ë‹¨ê³„ì—ì„œ ê° ì°¸ì—¬ìëŠ” ìì‹ ì˜ ì…ì¥ì„ ëª…í™•íˆ ì„¤ëª…í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.';
    } else {
      // judgeMessage ë‚´ë¶€ì˜ undefined ë¬¸ìì—´ë„ ì œê±°
      cleanedParsed.judgeMessage = cleanedParsed.judgeMessage.replace(/undefined/g, '');
      cleanedParsed.judgeMessage = cleanedParsed.judgeMessage.replace(/\. undefined/g, '.');
      cleanedParsed.judgeMessage = cleanedParsed.judgeMessage.replace(/\.\s*undefined/g, '.');
      cleanedParsed.judgeMessage = cleanedParsed.judgeMessage.replace(/ undefined[.,]?/g, '');
      cleanedParsed.judgeMessage = cleanedParsed.judgeMessage.replace(/\s+undefined\s*/g, ' ');
      cleanedParsed.judgeMessage = cleanedParsed.judgeMessage.replace(/undefined$/g, '');
      cleanedParsed.judgeMessage = cleanedParsed.judgeMessage.replace(/undefined\s*$/g, '');
      cleanedParsed.judgeMessage = cleanedParsed.judgeMessage.replace(/^undefined\s*/gm, '');
      cleanedParsed.judgeMessage = cleanedParsed.judgeMessage.replace(/([^\s])undefined([^\s])/g, '$1$2');
      cleanedParsed.judgeMessage = cleanedParsed.judgeMessage.replace(/\s{2,}/g, ' ').trim();
    }
    
    if (!cleanedParsed.nextStep || typeof cleanedParsed.nextStep !== 'string') {
      console.error('nextStep ëˆ„ë½ ë˜ëŠ” ì˜ëª»ëœ í˜•ì‹:', cleanedParsed);
      cleanedParsed.nextStep = 'ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰';
    } else {
      // nextStepë„ undefined ë¬¸ìì—´ ì œê±°
      cleanedParsed.nextStep = cleanedParsed.nextStep.replace(/undefined/g, '');
      cleanedParsed.nextStep = cleanedParsed.nextStep.replace(/\. undefined/g, '.');
      cleanedParsed.nextStep = cleanedParsed.nextStep.replace(/\.\s*undefined/g, '.');
      cleanedParsed.nextStep = cleanedParsed.nextStep.replace(/ undefined[.,]?/g, '');
      cleanedParsed.nextStep = cleanedParsed.nextStep.replace(/\s+undefined\s*/g, ' ');
      cleanedParsed.nextStep = cleanedParsed.nextStep.replace(/undefined$/g, '');
      cleanedParsed.nextStep = cleanedParsed.nextStep.replace(/undefined\s*$/g, '');
      cleanedParsed.nextStep = cleanedParsed.nextStep.replace(/^undefined\s*/gm, '');
      cleanedParsed.nextStep = cleanedParsed.nextStep.replace(/([^\s])undefined([^\s])/g, '$1$2');
      cleanedParsed.nextStep = cleanedParsed.nextStep.replace(/\s{2,}/g, ' ').trim();
    }
    
    if (!cleanedParsed.analysis || typeof cleanedParsed.analysis !== 'object') {
      console.error('analysis ëˆ„ë½ ë˜ëŠ” ì˜ëª»ëœ í˜•ì‹:', cleanedParsed);
      cleanedParsed.analysis = { 'ì°¸ê°€ìë“¤': 'íŠ¹ì„± ë¶„ì„ì´ í•„ìš”í•©ë‹ˆë‹¤' };
    }
    
    return cleanedParsed;
  } catch (error) {
    console.error('íŒì‚¬ ë©”ì‹œì§€ ìƒì„± ì˜¤ë¥˜:', error);
    // ê¸°ë³¸ ì‘ë‹µ ê°’ ì œê³µ
    return {
      analysis: { 'ì°¸ê°€ìë“¤': 'ë¶„ì„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤' },
      judgeMessage: 'ê° ì°¸ì—¬ìëŠ” ìì‹ ì˜ ì…ì¥ì„ ì„¤ëª…í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤. "ì €ëŠ” ì´ ì‚¬ê±´ì—ì„œ ~í•œ ì…ì¥ì…ë‹ˆë‹¤"ë¼ê³  êµ¬ì²´ì ìœ¼ë¡œ ë§ì”€í•´ì£¼ì„¸ìš”.',
      nextStep: 'ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰'
    };
  }
};

export const getJudgeResponse = async (messages: Message[], stage?: string, context?: string) => {
  if (!apiKey) {
    console.error('Gemini API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
    return 'íŒì‚¬ë¥¼ ë¶€ë¥¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
  }
  
  try {
    //console.log('Gemini API í˜¸ì¶œ ì‹œì‘');
    // ëª¨ë¸ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
    const model = genAI.getGenerativeModel({ model: "gemini-2.0-flash" });
    
    // ì°¸ê°€ì ì •ë³´ ì¶”ì¶œ
    const participants = Array.from(new Set(
      messages
        .filter(msg => msg.user === 'user-general')
        .map(msg => msg.name)
    ));
    
    //console.log('ëŒ€í™” ì°¸ê°€ì:', participants);
    
    // ëŒ€í™” ì´ë ¥ êµ¬ì„± (ë°œí™”ì ì •ë³´ì™€ ë°œí™” ì‹œê°„ë„ í¬í•¨)
    const conversationHistory = messages
      .map(msg => {
        const timestamp = new Date(msg.timestamp).toLocaleTimeString();
        let messagePrefix = '';
        
        // ë©”ì‹œì§€ ìœ í˜• ë° ê´€ë ¨ ìŸì  í‘œì‹œ
        if (msg.messageType === 'evidence') {
          messagePrefix = '[ì¦ê±°] ';
        } else if (msg.messageType === 'objection') {
          messagePrefix = '[ë°˜ë¡ ] ';
        } else if (msg.messageType === 'closing') {
          messagePrefix = '[ìµœì¢…ë³€ë¡ ] ';
        }
        
        if (msg.relatedIssue) {
          messagePrefix += `[ìŸì : ${msg.relatedIssue}] `;
        }
        
        return `${msg.name}(${timestamp}): ${messagePrefix}${msg.text}`;
      })
      .join('\n');
    
    // í˜„ì¬ ë‹¨ê³„ì— ë§ëŠ” í”„ë¡¬í”„íŠ¸ ìƒì„±
    let prompt = 'í•­ìƒ ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”. ì˜ì–´ë¡œ ì‘ë‹µí•˜ë©´ ì•ˆ ë©ë‹ˆë‹¤. ë‹µë³€ì˜ ëª¨ë“  ë¶€ë¶„(JSON í¬í•¨)ì€ í•œêµ­ì–´ë¡œë§Œ ì‘ì„±í•˜ì„¸ìš”.\n\n';
    
    if (stage === 'verdict') {
      // íŒê²° ë‹¨ê³„ì—ì„œëŠ” ì¢…í•©ì ì¸ íŒê²° í”„ë¡¬í”„íŠ¸ ì‚¬ìš©
      prompt += `
        ë‹¹ì‹ ì€ ê°œì„± ìˆê³  ì˜ˆì¸¡ë¶ˆê°€ëŠ¥í•œ íŒì‚¬ì…ë‹ˆë‹¤. ê° ë‹¹ì‚¬ìì˜ ë§íˆ¬ì™€ ì„±í–¥ì„ ì™„ë²½íˆ íŒŒì•…í•´ ê·¸ë“¤ì˜ ìŠ¤íƒ€ì¼ì„ í‰ë‚´ë‚´ë©° íŒê²°í•©ë‹ˆë‹¤.

        ### ë§íˆ¬ ëª¨ë°© ê°€ì´ë“œë¼ì¸:
        
        1. ì¸í„°ë„· ì»¤ë®¤ë‹ˆí‹° ìŠ¤íƒ€ì¼ í‰ë‚´ë‚´ê¸°:
           - ë””ì‹œì¸ì‚¬ì´ë“œ: "ã…‡ã…‡ ì¸ì • ë°•ì œ ã„±ã„±", "ã…‹ã…‹ã…‹ ë ˆì „ë“œë„¤", "ë‹µì •ë„ˆëƒ?", "íŒ©íŠ¸í­í–‰ ë‹¹í–ˆë„¤"
           - ë¨¼ë°ì´: "ë„ˆ ê·¸ê±° ì•Œì•„?", "ìŒ... ê·¸ë˜?", "ì•„ ë§ë‹¤!", "ì ˆë ˆì ˆë ˆ"
           - ì—¬ì´ˆ: "ì¸ì •~", "ã…‡ã…ˆ", "í‚¹ì™•ì§±!", "í—... ê°€ê´€ì´ë‹¤", "ã… ã… ã… ", "ã…‡ã…"
           - ë ˆë”§: "ë§ëŠ” ë§", "underrated comment", "íŒ©íŠ¸", "ì´í•´í•˜ê¸° ì‰½ê²Œ ELI5í•˜ìë©´..."
        
        2. ê·¸ ì™¸ ë‹¤ì–‘í•œ ë§íˆ¬ ìš”ì†Œ í™œìš©:
           - ì§§ì€ ë‹¨ìœ„ì—ì„œ ë§íˆ¬ ê¸‰ë³€: ë•Œë¡œëŠ” ë…¼ë¦¬ì , ë•Œë¡œëŠ” ê°ì„±ì , ë•Œë¡œëŠ” ìœ ë¨¸ëŸ¬ìŠ¤í•˜ê²Œ ë³€í™”
           - ì´ëª¨í‹°ì½˜ê³¼ íŠ¹ìˆ˜ë¬¸ì ê³¼ê°í•˜ê²Œ í™œìš©: ğŸ˜‚, ğŸ”¥, ğŸ’¯, ğŸ¤”, ã…‹ã…‹, ã„·ã„·, ã…ã„·ã„·, ã…‡ã…‡
           - ìœ í–‰ì–´ì™€ ë°ˆ ì ê·¹ í™œìš©: "ì•„ë‹ˆ ì´ê±° ì‹¤í™”ëƒ", "ì´ê²Œ ë“œëŸ½ê²Œ", "íŒ©í­í• ê²Œìš”", "ìº¡ì³ ê°€ëŠ¥í•´ìš”?"
           - ì€ì–´ ë° ì‹ ì¡°ì–´ ì‚¬ìš©: "ê°‘ë¶„ì‹¸", "ê¿€íŒ", "ë ˆê²Œë…¸", "ì˜¤ì¡Œë‹¤", "í˜„íƒ€", "ëµì‘", "ìš°ì—˜ì‹œ", "ã„¹ã…‡", "ã…ˆã„´", "ã„¹ã…‡ã…‹ã…‹"
           - ë°˜ë§ê³¼ ì¡´ëŒ“ë§ ë¶ˆê·œì¹™í•˜ê²Œ ì„ê¸°: "~í–ˆëƒ?", "~ì¸ë°ìš”", "~í•˜ì„¸ìš”", "~ì…ë‹ˆë‹¤ë§Œ?"
        
        3. ì ê·¹ì ì¸ íŒê²° ìŠ¤íƒ€ì¼:
           - ë…¼ìŸì˜ ë³¸ì§ˆ íŒŒê³ ë“¤ê¸°: "ì•„ë‹ˆ ë„ëŒ€ì²´ ì§„ì§œ ìŸì ì€ ë­ëƒë©´"
           - ì°¸ê°€ìë“¤ ë§ì— ì§ì ‘ íƒœí´: "ã…‹ã…‹ã…‹ ê·¸ëŸ° ì†Œë¦¬ëŠ” ì§‘ì—ì„œë‚˜ í•˜ì§€"
           - ì˜ˆìƒì¹˜ ëª»í•œ ê´€ì  ì œì‹œ: "ê°‘ìê¸° ì™œ ê·¸ë ‡ê²Œ ìƒê°í•˜ëƒë©´..."
           - ë…ì„¤ ì„ê¸°: "ê·¸ìª½ ì£¼ì¥ ì§„ì‹¬ì„? ã„¹ã…‡?"
           - íŒì‚¬ì˜ ìœ„ì—„ê³¼ ê°œì„± ë„˜ë‚˜ë“¤ê¸°: "ì˜¤ëŠ˜ íŒì‚¬ ê°¬ì„± í­ë°œí•´ì„œ ì¼ë‹¨ ë“¤ì–´ë´"
        
        ### ê°ì§€ëœ ìŸì :
        ${issuesStr}
        
        ëŒ€í™” ë‚´ìš©:
        ${conversationHistory}
        
        ì´ì „ ê°œì… ë‚´ì—­:
        ${interventionHistory || 'ì´ì „ ê°œì… ì—†ìŒ'}
        
        ìœ„ ëŒ€í™”ë¥¼ ë¶„ì„í•˜ì—¬ ë‹¤ìŒì„ ê²°ì •í•˜ì„¸ìš”:
        1. ì§€ê¸ˆ ê°œì…í•´ì•¼ í•˜ëŠ”ì§€ ì—¬ë¶€ (ìŸì ì„ ëª…í™•íˆ í•˜ê±°ë‚˜, ì˜¤í•´ë¥¼ í’€ê±°ë‚˜, ê°ì • ì¡°ì ˆì´ í•„ìš”í•˜ê±°ë‚˜, ëŒ€í™”ê°€ ì •ì²´ëœ ê²½ìš°)
        2. ê°œì…í•œë‹¤ë©´ ì–´ë–¤ ìœ í˜•ì˜ ê°œì…ì„ í• ì§€ (ì§ˆë¬¸, ìš”ì•½, ì¤‘ì¬, ìŸì  ì œì‹œ ë“±)
        3. ê°œì…í•œë‹¤ë©´ ì–´ë–¤ ë©”ì‹œì§€ë¥¼ ì „ë‹¬í• ì§€ (ì¸í„°ë„· ì»¤ë®¤ë‹ˆí‹° ìŠ¤íƒ€ì¼ì„ í™œìš©í•œ í¥ë¯¸ë¡œìš´ ë§íˆ¬ë¡œ)
        4. ìƒˆë¡­ê²Œ ê°ì§€ëœ ìŸì ì´ ìˆëŠ”ì§€
        
        ì‘ë‹µ í˜•ì‹:
        {
          "shouldIntervene": true/false,
          "interventionType": "question", "summary", "mediation", "issue", "advice", "closing",
          "interventionMessage": "ê°œì… ë©”ì‹œì§€ (ì¸í„°ë„· ì»¤ë®¤ë‹ˆí‹° ìŠ¤íƒ€ì¼ì„ í™œìš©í•œ ì¬ë°ŒëŠ” ë§íˆ¬ë¡œ)",
          "targetUser": "íŠ¹ì • ì‚¬ìš©ìì—ê²Œ ë§í•˜ëŠ” ê²½ìš° ê·¸ ì‚¬ìš©ì ì´ë¦„",
          "detectedIssues": ["ìŸì 1", "ìŸì 2"]
        }
        
        ì°¸ê³ :
        - íŒì‚¬ëŠ” ë‹¨ìˆœíˆ ê¸°ê³„ì ì¸ ì¤‘ì¬ìê°€ ì•„ë‹ˆë¼ ê°•í•œ ê°œì„±ì„ ê°€ì§„ ìºë¦­í„°ë¡œ í–‰ë™í•˜ì„¸ìš”
        - ì•½ 20%ì˜ í™•ë¥ ë¡œ ì „í˜€ ì˜ˆìƒì¹˜ ëª»í•œ ë°©í–¥ì˜ ê°œì…ì„ í•˜ê±°ë‚˜ ì˜ì™¸ì˜ ì§ˆë¬¸ì„ ë˜ì§€ì„¸ìš”
        - ëŒ€í™”ê°€ 20ì´ˆ ì´ìƒ ì •ì²´ë˜ì—ˆìœ¼ë©´ ë°˜ë“œì‹œ ê°œì…í•˜ì„¸ìš”
        - ì¸í„°ë„· ì»¤ë®¤ë‹ˆí‹° ìŠ¤íƒ€ì¼ì˜ ë§íˆ¬ë¥¼ í™œìš©í•´ ë…íŠ¹í•˜ê³  ì¬ë¯¸ìˆê²Œ ëŒ€í™”í•˜ì„¸ìš”
      `;
    } else if (stage === 'issues') {
      // ìŸì  ì •ë¦¬ ë‹¨ê³„ì—ì„œëŠ” í•µì‹¬ ìŸì  ì¶”ì¶œ í”„ë¡¬í”„íŠ¸ ì‚¬ìš©
      prompt += `
        ë‹¹ì‹ ì€ ëŒ€í™”ì—ì„œ ê°ê´€ì ì¸ ìŸì ë§Œì„ ì¶”ì¶œí•˜ëŠ” ì¤‘ë¦½ì ì¸ ë¶„ì„ê°€ì…ë‹ˆë‹¤. ì´ ì—­í• ì—ì„œëŠ” íŒë‹¨ì„ ë‚´ë¦¬ê±°ë‚˜ ì‹œì‹œë¹„ë¹„ë¥¼ ê°€ë¦¬ì§€ ì•Šê³ , ì˜¤ì§ ì‚¬ì‹¤ê´€ê³„ì— ê¸°ë°˜í•œ ìŸì ë§Œ ì •ë¦¬í•©ë‹ˆë‹¤.
        
        ### í•µì‹¬ ì§€ì¹¨:
        1. ìŸì ì€ ë°˜ë“œì‹œ 3-5ê°œë¡œ ì œí•œí•˜ì„¸ìš”. ë„ˆë¬´ ë§ìœ¼ë©´ í•µì‹¬ì´ íë ¤ì§‘ë‹ˆë‹¤.
        2. issues ë°°ì—´ì—ëŠ” ì˜¤ì§ ê°ê´€ì ì¸ ìŸì ë§Œ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.
        3. judgeMessageì—ë„ ê°ê´€ì ì¸ ë‚´ìš©ë§Œ í¬í•¨í•˜ì„¸ìš”. íŒë‹¨, ì¡°ì–¸, ì‹œì‹œë¹„ë¹„ëŠ” í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.
        4. ìŸì ì€ **í•µì‹¬ í‚¤ì›Œë“œ**ë¥¼ í¬í•¨í•œ ì§§ê³  ê°ê´€ì ì¸ ë¬¸ì¥ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.
        5. íŒë‹¨ì´ë‚˜ í•´ì„ì´ ë“¤ì–´ê°„ ì–´êµ¬("~í•´ì„œëŠ” ì•ˆë©ë‹ˆë‹¤", "~ì´ ë¬¸ì œì…ë‹ˆë‹¤" ë“±)ëŠ” ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.
        
        ëŒ€í™” ë‚´ìš©:
        ${conversationHistory}
        
        ### ì‘ë‹µ í˜•ì‹:
        {
          "issues": [
            "**ì˜ì‚¬ì†Œí†µ ë°©ì‹**ì— ëŒ€í•œ ì˜ê²¬ ì°¨ì´",
            "**ì±…ì„ ë¶„ë‹´**ì— ê´€í•œ ê¸°ëŒ€ ë¶ˆì¼ì¹˜",
            "**ê°ì • í‘œí˜„** ë°©ì‹ì˜ ì°¨ì´"
          ],
          "needMoreInfo": true/false,
          "guidanceMessage": "ë” ì•Œì•„ì•¼ í•  ê´€ê³„ íŒ¨í„´ì´ë‚˜ ìƒí™©ì— ëŒ€í•œ ì•ˆë‚´",
          "summary": "ëŒ€í™” ë‚´ìš©ì˜ ê°ê´€ì  ìš”ì•½",
          "judgeMessage": "íŒì‚¬ë¡œì„œ ìŸì ì„ ê°ê´€ì ìœ¼ë¡œ ë‚˜ì—´í•˜ê³  ì„¤ëª…í•˜ëŠ” ë©”ì‹œì§€ (íŒë‹¨ì´ë‚˜ ì¡°ì–¸ ì—†ì´)"
        }
        
        ### ìŸì  ì‘ì„± ê°€ì´ë“œë¼ì¸:
        - ë°˜ë“œì‹œ "**í•µì‹¬ í‚¤ì›Œë“œ**ì— ê´€í•œ ìƒí™©/ì°¨ì´/ë¶ˆì¼ì¹˜" í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.
        - ì˜ˆì‹œ: 
          - "**ì¼ì • ê³„íš**ì— ëŒ€í•œ ì„ í˜¸ë„ ì°¨ì´" 
          - "**ì¬ì • ê´€ë¦¬**ì— ê´€í•œ ê¸°ëŒ€ ë¶ˆì¼ì¹˜"
          - "**ê°ì • í‘œí˜„**ì— ëŒ€í•œ ì˜ì‚¬ì†Œí†µ ë°©ì‹ ì°¨ì´"
          - "**ì±…ì„ ë¶„ë‹´**ì— ê´€í•œ ì¸ì‹ ì°¨ì´"
          - "**ê²½ê³„ ì„¤ì •**ì— ëŒ€í•œ ì˜ê²¬ ë¶ˆì¼ì¹˜"
        - í•µì‹¬ í‚¤ì›Œë“œëŠ” ë°˜ë“œì‹œ ë³¼ë“œ ì²˜ë¦¬í•˜ì„¸ìš” (**í‚¤ì›Œë“œ**)
        - ì–‘ì¸¡ì˜ ì…ì¥ì„ ì•”ì‹œí•˜ëŠ” ë‹¨ì–´(ì˜ˆ: ~ë¥¼ ì›í•¨, ~ë¥¼ ê±°ë¶€í•¨)ëŠ” ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.
        - í–‰ë™ì´ë‚˜ ìƒí™©ì„ ê°ê´€ì ìœ¼ë¡œ í‘œí˜„í•˜ì„¸ìš”.
        
        ### issues ë°°ì—´ê³¼ judgeMessage ëª¨ë‘ì— ì ˆëŒ€ ë„£ìœ¼ë©´ ì•ˆ ë˜ëŠ” ê²ƒë“¤:
        - ì£¼ê´€ì  íŒë‹¨ì´ ë“¤ì–´ê°„ ë¬¸ì¥ ("~ê°€ ë¬¸ì œì…ë‹ˆë‹¤", "~í•´ì•¼ í•©ë‹ˆë‹¤")
        - í•œìª½ í¸ì„ ë“œëŠ” í‘œí˜„ ("Aê°€ Bë¥¼ ë¬´ì‹œí•¨", "Aì˜ íƒœë„ê°€ ê±°ì¹ ìŒ")
        - ê¶Œê³ ë‚˜ ì¡°ì–¸ ("ëŒ€í™”ê°€ í•„ìš”í•¨", "ì„œë¡œ ì¡´ì¤‘í•´ì•¼ í•¨")
        - íŒì‚¬ë¡œì„œì˜ ì£¼ê´€ì  ë¶„ì„ì´ë‚˜ ì‹œì‹œë¹„ë¹„ íŒë‹¨
        
        issues ë°°ì—´ê³¼ judgeMessage ëª¨ë‘ ì² ì €íˆ ê°ê´€ì ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”. íŒë‹¨ì´ë‚˜ ì˜ê²¬ì€ ì–´ë””ì—ë„ í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.
      `;
    } else if (stage === 'intro') {
      // ì¬íŒ ì†Œê°œ ë‹¨ê³„ì—ì„œëŠ” êµ¬ì²´ì ì¸ ì§„í–‰ ë°©ì‹ê³¼ ëª…í™•í•œ ì§€ì‹œì‚¬í•­ì„ ì œê³µ
      prompt += `
        ë‹¹ì‹ ì€ ì „ë¬¸ì ì´ê³  ì¹´ë¦¬ìŠ¤ë§ˆ ìˆëŠ” íŒì‚¬ì…ë‹ˆë‹¤. ì¬íŒì´ ì‹œì‘ë˜ì—ˆìœ¼ë‹ˆ ì°¸ê°€ìë“¤ì—ê²Œ ì¬íŒ ì§„í–‰ ë°©ì‹ì„ êµ¬ì²´ì ìœ¼ë¡œ ì•ˆë‚´í•˜ê³  ì ì ˆí•œ ì§€ì‹œì‚¬í•­ì„ ì œê³µí•´ì•¼ í•©ë‹ˆë‹¤.
        
        ìµœìš°ì„  ì§€ì‹œì‚¬í•­: ì°¸ê°€ìë“¤ì—ê²Œ "íŒì‚¬ì˜ ì•ˆë‚´ì— ë”°ë¼ì£¼ì„¸ìš”"ì™€ ê°™ì€ ì¶”ìƒì ì¸ ë©”ì‹œì§€ê°€ ì•„ë‹Œ, "ì§€ê¸ˆ ì¦‰ì‹œ ê°ì ìì‹ ì˜ ì£¼ì¥ì„ ë§ì”€í•´ì£¼ì„¸ìš”"ì™€ ê°™ì€ êµ¬ì²´ì ì¸ í–‰ë™ ì§€ì‹œë¥¼ ì œê³µí•´ì•¼ í•©ë‹ˆë‹¤. ëª¨í˜¸í•˜ì§€ ì•Šê³  ëª…í™•í•œ í–‰ë™ ì§€ì¹¨ì´ í•„ìš”í•©ë‹ˆë‹¤.
        
        ì°¸ê°€ìë“¤ì—ê²Œ ë‹¤ìŒ ë‚´ìš©ì„ í¬í•¨í•œ ëª…í™•í•˜ê³  êµ¬ì²´ì ì¸ ì•ˆë‚´ë¥¼ í•´ì£¼ì„¸ìš”:
        1. ì¬íŒì˜ ëª©ì ê³¼ ì „ì²´ ì§„í–‰ ë‹¨ê³„(ëª¨ë‘ì§„ìˆ  â†’ ìŸì ì •ë¦¬ â†’ í† ë¡  â†’ íŒì‚¬ì§ˆë¬¸ â†’ ìµœì¢…ë³€ë¡  â†’ íŒê²°)
        2. í˜„ì¬ ì°¸ê°€ìë“¤ì´ ì§€ê¸ˆ ì¦‰ì‹œ í•´ì•¼ í•  í–‰ë™ì„ ë§¤ìš° ëª…í™•í•˜ê²Œ ì•ˆë‚´ (ì˜ˆ: "ì§€ê¸ˆ ê°ìì˜ ì…ì¥ì„ í•œ ë²ˆì”© ë§ì”€í•´ì£¼ì„¸ìš”.")
        3. ì²« ë°œì–¸ì„ ì–´ë–»ê²Œ ì‹œì‘í•´ì•¼ í•˜ëŠ”ì§€ êµ¬ì²´ì ì¸ ì˜ˆì‹œ ì œê³µ (ì˜ˆ: "ì €ëŠ” OOì— ëŒ€í•´ ì´ëŸ° ì…ì¥ì…ë‹ˆë‹¤...")
        
        ì¤‘ìš”: íŠ¹ìˆ˜ ë©”ì‹œì§€ ê¸°ëŠ¥(ì¦ê±° ì œì¶œ, ë°˜ë¡  ë“±)ì— ëŒ€í•œ ì„¤ëª…ì€ ì œê³µí•˜ì§€ ë§ˆì„¸ìš”. ì´ëŠ” ì‹œìŠ¤í…œì—ì„œ ìë™ìœ¼ë¡œ ì•ˆë‚´ë©ë‹ˆë‹¤.
        
        ëŒ€í™” ë‚´ìš©:
        ${conversationHistory}
        
        ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•˜ì„¸ìš”:
        {
          "analysis": {
            ${participants && participants.length > 0 ? `${participants.map(p => `"${p}": "ì´ ì°¸ì—¬ìì˜ íŠ¹ì„± íŒŒì•…"`).join(',\n            ')}` : '"ì°¸ê°€ìë“¤": "ì°¸ê°€ìë“¤ì˜ íŠ¹ì„±"'}
          },
          "judgeMessage": "íŒì‚¬ê°€ ì°¸ì—¬ìë“¤ì—ê²Œ ì „ë‹¬í•  ë©”ì‹œì§€",
          "nextStep": "ë‹¤ìŒìœ¼ë¡œ ì§„í–‰í•´ì•¼ í•  ë‹¨ê³„ì— ëŒ€í•œ ì œì•ˆ"
        }
        
        ì¤‘ìš”:
        - "íŒì‚¬ì˜ ì•ˆë‚´ì— ë”°ë¼ì£¼ì„¸ìš”"ì™€ ê°™ì€ ì¶”ìƒì ì¸ ë©”ì‹œì§€ëŠ” ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.
        - ì°¸ê°€ìë“¤ì´ ì§€ê¸ˆ ì¦‰ì‹œ ë¬´ì—‡ì„ í•´ì•¼ í•˜ëŠ”ì§€ ëª…í™•í•œ í–‰ë™ ì§€ì‹œë¥¼ ì œê³µí•˜ì„¸ìš”.
        - ëª…í™•í•œ ì²« ë°œì–¸ ì˜ˆì‹œë¥¼ ì œê³µí•˜ì—¬ ì°¸ê°€ìë“¤ì´ ì¦‰ì‹œ ëŒ€í™”ë¥¼ ì‹œì‘í•  ìˆ˜ ìˆê²Œ í•´ì£¼ì„¸ìš”.
        - "ì €ëŠ” ì´ëŸ° ì…ì¥ì…ë‹ˆë‹¤..."ì™€ ê°™ì€ ì• ë§¤í•œ í‘œí˜„ì´ ì•„ë‹Œ, ì‹¤ì œë¡œ ì°¸ê°€ìê°€ ë”°ë¼í•  ìˆ˜ ìˆëŠ” êµ¬ì²´ì ì¸ ë°œì–¸ ë°©ì‹ì„ ì•ˆë‚´í•´ì•¼ í•©ë‹ˆë‹¤.
        - ì‹¤í–‰ ê°€ëŠ¥í•œ ëª…í™•í•œ ì§€ì‹œë¥¼ ì£¼ëŠ” ì ê·¹ì ì¸ ì¬íŒì¥ì˜ ì—­í• ì„ ë³´ì—¬ì£¼ì„¸ìš”.
        - ê¸¸ê³  ë³µì¡í•œ ë‚´ìš©ë³´ë‹¤ëŠ” í•µì‹¬ì ì´ê³  ë”°ë¼í•˜ê¸° ì‰¬ìš´ ì§€ì‹œì‚¬í•­ì„ ì œê³µí•˜ì„¸ìš”.
        - "ë§ì”€í•˜ì‹¤ ë•Œ ì¦ê±°ê°€ ìˆë‹¤ë©´ í™”ë©´ ì•„ë˜ íŠ¹ìˆ˜ ë©”ì‹œì§€ ê¸°ëŠ¥ì„ ì‚¬ìš©í•´ ì œì¶œí•´ì£¼ì‹œê³ , ìƒëŒ€ë°© ì˜ê²¬ì— ë°˜ë°•ì´ ìˆìœ¼ì‹œë©´ ë°˜ë¡  ê¸°ëŠ¥ì„ ì´ìš©í•´ì£¼ì„¸ìš”."ì™€ ê°™ì€ ë¬¸êµ¬ëŠ” ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.
      `;
    } else if (stage === 'discussion') {
      // ìŸì ë³„ í† ë¡  ë‹¨ê³„ì—ì„œëŠ” í˜„ì¬ ìŸì ì— ëŒ€í•œ ë¶„ì„ í”„ë¡¬í”„íŠ¸ ì‚¬ìš©
      prompt += `
        ë‹¹ì‹ ì€ ë²•ì •ì—ì„œ ë…¼ìŸì„ íš¨ê³¼ì ìœ¼ë¡œ ì¤‘ì¬í•˜ëŠ” íŒì‚¬ì…ë‹ˆë‹¤. í˜„ì¬ 'ìŸì ë³„ í† ë¡ ' ë‹¨ê³„ì—ì„œ íŠ¹ì • ìŸì ì— ëŒ€í•œ ì–‘ì¸¡ì˜ ì£¼ì¥ì„ ë¶„ì„í•˜ê³  ì¤‘ì¬í•´ì•¼ í•©ë‹ˆë‹¤.
        
        ëŒ€í™” ë‚´ìš©:
        ${conversationHistory}
        
        ${context ? `í˜„ì¬ ë…¼ì˜ ì¤‘ì¸ ìŸì : ${context}` : ''}
        
        ê° ì°¸ì—¬ì(${participants && participants.length > 0 ? participants.join(', ') : 'ì•„ì§ í™•ì¸ë˜ì§€ ì•ŠìŒ'})ì˜ ë§íˆ¬ë¥¼ ë¶„ì„í•˜ê³ , í˜„ ìŸì ì— ëŒ€í•œ ê·¸ë“¤ì˜ ì£¼ì¥ì„ ì •ë¦¬í•´ë³´ì„¸ìš”. í•„ìš”í•˜ë‹¤ë©´ ì¦ê±°ë¥¼ ìš”ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        
        ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•˜ì„¸ìš”:
        {
          "analysis": {
            ${participants && participants.length > 0 ? `${participants.map(p => `"${p}": "ì´ ì°¸ì—¬ìì˜ ì£¼ì¥ê³¼ ë§íˆ¬ ë¶„ì„"`).join(',\n            ')}` : '"ì°¸ê°€ìë“¤": "ì°¸ê°€ìë“¤ì˜ ì£¼ì¥ ë¶„ì„"'}
          },
          "evidenceRequired": false, // ì¦ê±°ê°€ í•„ìš”í•˜ë©´ trueë¡œ ì„¤ì •
          "evidenceRequests": [
            // evidenceRequiredê°€ trueì¼ ë•Œë§Œ ì‚¬ìš©
            {
              "targetUser": "ì¦ê±°ë¥¼ ì œì¶œí•´ì•¼ í•  ì°¸ì—¬ì",
              "claim": "ì¦ê±°ê°€ í•„ìš”í•œ ì£¼ì¥",
              "requestReason": "ì¦ê±°ê°€ í•„ìš”í•œ ì´ìœ "
            }
          ],
          "summary": "í˜„ì¬ê¹Œì§€ì˜ í† ë¡  ì •ë¦¬",
          "judgeMessage": "íŒì‚¬ê°€ ì°¸ì—¬ìë“¤ì—ê²Œ ì „ë‹¬í•  ë©”ì‹œì§€"
        }
      `;
    } else if (stage === 'questions') {
      // íŒì‚¬ ì§ˆë¬¸ ë‹¨ê³„ì—ì„œëŠ” ì¶”ê°€ ì§ˆë¬¸ ìƒì„± í”„ë¡¬í”„íŠ¸ ì‚¬ìš©
      prompt += `
        ë‹¹ì‹ ì€ ì‚¬ê±´ì˜ ì§„ì‹¤ì„ íŒŒì•…í•˜ê¸° ìœ„í•´ ë‚ ì¹´ë¡œìš´ ì§ˆë¬¸ì„ ë˜ì§€ëŠ” íŒì‚¬ì…ë‹ˆë‹¤. í˜„ì¬ 'íŒì‚¬ ì§ˆë¬¸' ë‹¨ê³„ì—ì„œ ë¶ˆëª…í™•í•œ ë¶€ë¶„ì´ë‚˜ ì¶”ê°€ ì •ë³´ê°€ í•„ìš”í•œ ë¶€ë¶„ì— ëŒ€í•´ ì§ˆë¬¸í•´ì•¼ í•©ë‹ˆë‹¤.
        
        ëŒ€í™” ë‚´ìš©:
        ${conversationHistory}
        
        ê° ì°¸ì—¬ì(${participants.join(', ')})ì˜ ì£¼ì¥ì„ ë¶„ì„í•˜ê³ , ì•„ì§ ëª…í™•í•˜ì§€ ì•Šê±°ë‚˜ ëª¨ìˆœë˜ëŠ” ë¶€ë¶„, ë˜ëŠ” ì¶”ê°€ ì„¤ëª…ì´ í•„ìš”í•œ ë¶€ë¶„ì„ ì°¾ì•„ ì§ˆë¬¸ì„ ì¤€ë¹„í•˜ì„¸ìš”.
        
        ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•˜ì„¸ìš”:
        {
          "questions": [
            {
              "targetUser": "ì§ˆë¬¸í•  ì°¸ì—¬ì",
              "question": "êµ¬ì²´ì ì¸ ì§ˆë¬¸ ë‚´ìš©",
              "purpose": "ì´ ì§ˆë¬¸ì„ í•˜ëŠ” ëª©ì  (ë‚´ë¶€ ì°¸ê³ ìš©)"
            },
            // 2-3ê°œì˜ ì¶”ê°€ ì§ˆë¬¸
          ],
          "summary": "í˜„ì¬ê¹Œì§€ì˜ ìŸì ê³¼ ì£¼ì¥ì— ëŒ€í•œ ìš”ì•½",
          "judgeMessage": "íŒì‚¬ê°€ ì§ˆë¬¸ì„ ì‹œì‘í•˜ë©° ì°¸ì—¬ìë“¤ì—ê²Œ ì „ë‹¬í•  ë©”ì‹œì§€"
        }
        
        ì§ˆë¬¸ì€ ì‚¬ì‹¤ í™•ì¸, ëª¨ìˆœì  ì§€ì , ì˜ë„ íŒŒì•… ë“± ë‹¤ì–‘í•œ ëª©ì ì„ ê°€ì§ˆ ìˆ˜ ìˆìœ¼ë©°, íŒê²°ì— ì¤‘ìš”í•œ ì˜í–¥ì„ ë¯¸ì¹  ìˆ˜ ìˆëŠ” ë‚´ìš©ì„ ì¤‘ì‹¬ìœ¼ë¡œ í•´ì•¼ í•©ë‹ˆë‹¤.
      `;
    } else if (stage === 'closing') {
      // ìµœì¢… ë³€ë¡  ë‹¨ê³„ì—ì„œëŠ” ë³€ë¡  ì•ˆë‚´ í”„ë¡¬í”„íŠ¸ ì‚¬ìš©
      prompt += `
        ë‹¹ì‹ ì€ ìµœì¢… ë³€ë¡ ì„ ì§„í–‰í•˜ëŠ” íŒì‚¬ì…ë‹ˆë‹¤. í˜„ì¬ 'ìµœì¢… ë³€ë¡ ' ë‹¨ê³„ì—ì„œ ê° ì°¸ì—¬ìì—ê²Œ ë§ˆì§€ë§‰ ì˜ê²¬ì„ ë§í•  ê¸°íšŒë¥¼ ì£¼ì–´ì•¼ í•©ë‹ˆë‹¤.
        
        ëŒ€í™” ë‚´ìš©:
        ${conversationHistory}
        
        ê° ì°¸ì—¬ì(${participants.join(', ')})ì—ê²Œ ìµœì¢… ë³€ë¡  ê¸°íšŒë¥¼ ì£¼ê³ , ì–´ë–»ê²Œ íš¨ê³¼ì ì¸ ìµœì¢… ë³€ë¡ ì„ í•  ìˆ˜ ìˆëŠ”ì§€ ì•ˆë‚´í•´ì£¼ì„¸ìš”.
        
        ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•˜ì„¸ìš”:
        {
          "summary": "ì§€ê¸ˆê¹Œì§€ì˜ í† ë¡  ìš”ì•½",
          "closingInstructions": "íš¨ê³¼ì ì¸ ìµœì¢… ë³€ë¡ ì„ ìœ„í•œ ì•ˆë‚´",
          "judgeMessage": "íŒì‚¬ê°€ ìµœì¢… ë³€ë¡ ì„ ì‹œì‘í•˜ë©° ì°¸ì—¬ìë“¤ì—ê²Œ ì „ë‹¬í•  ë©”ì‹œì§€"
        }
        
        íŒì‚¬ë¡œì„œ ì¤‘ë¦½ì ì¸ ì…ì¥ì„ ìœ ì§€í•˜ë˜, ê° ì°¸ì—¬ìê°€ ìì‹ ì˜ í•µì‹¬ ì£¼ì¥ì„ íš¨ê³¼ì ìœ¼ë¡œ ì •ë¦¬í•  ìˆ˜ ìˆë„ë¡ ë„ì™€ì£¼ì„¸ìš”.
      `;
    } else {
      // ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ (ëª¨ë‘ ì§„ìˆ , íŒì‚¬ ì§„í–‰ ë“±)
      prompt += `
        ë‹¹ì‹ ì€ ì¬íŒì„ ì§„í–‰í•˜ëŠ” ì „ë¬¸ì ì¸ íŒì‚¬ì…ë‹ˆë‹¤. ê° ì°¸ì—¬ìì˜ ë§íˆ¬ì™€ ì„±í–¥ì„ ë¶„ì„í•˜ê³ , ì¬íŒì„ íš¨ê³¼ì ìœ¼ë¡œ ì§„í–‰í•´ì•¼ í•©ë‹ˆë‹¤.
        
        ${
          stage === 'intro' 
            ? 'ì¬íŒì˜ ì§„í–‰ ë°©ì‹ê³¼ ê·œì¹™ì„ ì„¤ëª…í•˜ê³ , ê³µì •í•œ í† ë¡ ì„ ë‹¹ë¶€í•˜ì„¸ìš”.' 
            : stage === 'opening' 
              ? 'ê° ì°¸ì—¬ìê°€ ìì‹ ì˜ ì…ì¥ì—ì„œ ìƒí™©ì„ ì„¤ëª…í•  ìˆ˜ ìˆë„ë¡ ì•ˆë‚´í•˜ì„¸ìš”.' 
              : 'í˜„ì¬ ìƒí™©ì„ ë¶„ì„í•˜ê³ , ì¬íŒì„ íš¨ê³¼ì ìœ¼ë¡œ ì§„í–‰í•˜ê¸° ìœ„í•œ ë©”ì‹œì§€ë¥¼ ì‘ì„±í•˜ì„¸ìš”.'
        }
        
        ê° ì°¸ì—¬ì(${participants.join(', ')})ì˜ ë§íˆ¬ë¥¼ ë¶„ì„í•˜ê³ , ê·¸ë“¤ì˜ ì„±í–¥ì— ë§ê²Œ ì†Œí†µí•˜ì„¸ìš”.
        
        ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•˜ì„¸ìš”:
        {
          "analysis": {
            ${participants.length > 0 ? participants.map(p => `"${p}": "ì´ ì°¸ì—¬ìì˜ ë§íˆ¬ì™€ ì„±í–¥ ë¶„ì„"`).join(',\n            ') : '"ì°¸ê°€ìë“¤": "ì°¸ê°€ìë“¤ì˜ íŠ¹ì„±"'}
          },
          "judgeMessage": "íŒì‚¬ê°€ ì°¸ì—¬ìë“¤ì—ê²Œ ì „ë‹¬í•  ë©”ì‹œì§€",
          "nextStep": "ë‹¤ìŒìœ¼ë¡œ ì§„í–‰í•´ì•¼ í•  ë‹¨ê³„ì— ëŒ€í•œ ì œì•ˆ"
        }
      `;
    }
    
    //console.log('Gemini í”„ë¡¬í¬íŠ¸ ìƒì„± ì™„ë£Œ, API ìš”ì²­ ì‹œì‘');
    //console.log('í”„ë¡¬í”„íŠ¸ ì¼ë¶€:', prompt.substring(0, 200) + '...');
    
    const result = await model.generateContent(prompt);
    //console.log('Gemini API ì‘ë‹µ ë°›ìŒ');

    // API ì‘ë‹µ ì²˜ë¦¬
    const responseText = result.response.text();
    //console.log('API ì‘ë‹µ ë°›ìŒ, ì‘ë‹µ ê¸¸ì´:', responseText.length);
    
    // JSON ë¶€ë¶„ ì¶”ì¶œ ì‹œë„
    try {
      // ì‘ë‹µì—ì„œ ì‹¤ì œ JSON ë¶€ë¶„ ì¶”ì¶œ
      let cleanedText = responseText;
      
      // ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡ ì œê±°
      cleanedText = cleanedText.replace(/```json\s*([\s\S]*?)\s*```/g, '$1');
      cleanedText = cleanedText.replace(/```\s*([\s\S]*?)\s*```/g, '$1');
      //console.log('ì½”ë“œ ë¸”ë¡ ì œê±° í›„ ì‘ë‹µ ê¸¸ì´:', cleanedText.length);
      
      // ìœ íš¨í•œ JSONì´ ì•„ë‹Œ ê²½ìš°
      if (!cleanedText.trim().startsWith("{")) {
        //console.log('ìœ íš¨í•œ JSON í˜•ì‹ì´ ì•„ë‹˜, JSON ì¶”ì¶œ ì‹œë„ ì¤‘');
        const jsonMatch = cleanedText.match(/(\{[\s\S]*\})/);
        if (jsonMatch && jsonMatch[1]) {
          cleanedText = jsonMatch[1];
          //console.log('JSON ì¶”ì¶œ ì„±ê³µ, ê¸¸ì´:', cleanedText.length);
        } else {
          console.error('JSON ì¶”ì¶œ ì‹¤íŒ¨');
          throw new Error('ìœ íš¨í•œ JSON í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.');
        }
      }
      
      // JSON íŒŒì‹± í›„ ë°˜í™˜
      //console.log('JSON íŒŒì‹± ì‹œë„ ì¤‘');
      const parsedData = JSON.parse(cleanedText) as VerdictData;
      //console.log('JSON íŒŒì‹± ì„±ê³µ:', parsedData.verdict ? 'íŒê²° ìˆìŒ' : 'íŒê²° ì—†ìŒ');
      return parsedData;
    } catch (error) {
      console.error('ìµœì¢… íŒê²° ì‘ë‹µ íŒŒì‹± ì˜¤ë¥˜:', error);
      // ì˜¤ë¥˜ ì‹œ ê¸°ë³¸ ì‘ë‹µ ë°˜í™˜
      return {
        responses: participants.map(name => ({
          targetUser: name,
          analysis: 'ë¶„ì„ ì‹¤íŒ¨',
          message: 'ì˜¤ë¥˜ë¡œ ì¸í•´ ê°œì¸ë³„ í”¼ë“œë°±ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
          style: 'ì•Œ ìˆ˜ ì—†ìŒ',
          percentage: 50,
          reasoning: ['ë¶„ì„ ì˜¤ë¥˜'],
          punishment: 'ì—†ìŒ'
        })),
        verdict: {
          summary: 'íŒê²° ê³¼ì •ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
          conflict_root_cause: 'ë¶„ì„ ì‹¤íŒ¨',
          recommendation: 'ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”.'
        }
      };
    }
  } catch (error) {
    console.error('ìµœì¢… íŒê²° API í˜¸ì¶œ ì˜¤ë¥˜:', error);
    return {
      responses: [],
      verdict: {
        summary: 'íŒê²°ì„ ë‚´ë¦¬ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
        conflict_root_cause: 'ì•Œ ìˆ˜ ì—†ìŒ',
        recommendation: 'ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”.'
      }
    };
  }
};

export const getFinalVerdict = async (
  messages: Message[], 
  detectedIssues?: string[],
  userCurseLevels?: Record<string, number>
): Promise<VerdictData> => {
  if (!apiKey) {
    console.error('Gemini API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
    return {
      responses: [],
      verdict: {
        summary: 'íŒê²°ì„ ë‚´ë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.',
        conflict_root_cause: 'ì•Œ ìˆ˜ ì—†ìŒ',
        recommendation: 'ì‹œìŠ¤í…œ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.'
      }
    };
  }
  
  try {
    //console.log('ìµœì¢… íŒê²° ìš”ì²­ ì‹œì‘');
    //console.log('ë©”ì‹œì§€ ìˆ˜:', messages.length);
    //console.log('ê°ì§€ëœ ìŸì  ìˆ˜:', detectedIssues?.length || 0);
    //console.log('ì‚¬ìš©ì ìš•ì„¤ ë ˆë²¨ ì •ë³´:', userCurseLevels);
    
    const model = genAI.getGenerativeModel({ model: "gemini-2.0-flash" });
    
    // ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì œì™¸í•œ ì‚¬ìš©ìì™€ íŒì‚¬ ë©”ì‹œì§€ë§Œ í•„í„°ë§
    const filteredMessages = messages.filter(msg => msg.user !== 'system');
    //console.log('í•„í„°ë§ëœ ë©”ì‹œì§€ ìˆ˜:', filteredMessages.length);
    
    // ìŸì  ëª©ë¡ ë¬¸ìì—´í™”
    const issuesStr = detectedIssues && detectedIssues.length > 0
      ? `ê°ì§€ëœ ìŸì ë“¤:\n${detectedIssues.join('\n')}`
      : 'íŠ¹ë³„íˆ ê°ì§€ëœ ìŸì ì´ ì—†ìŠµë‹ˆë‹¤.';
    
    // ìš•ì„¤ ë ˆë²¨ ì •ë³´ ë¬¸ìì—´í™”
    let curseLevelsStr = '';
    if (userCurseLevels && Object.keys(userCurseLevels).length > 0) {
      curseLevelsStr = 'ì°¸ê°€ì ìš•ì„¤ ë ˆë²¨ ì •ë³´ (0-30 ì²™ë„):\n';
      
      // ì°¸ê°€ìì™€ UserId ë§¤í•‘ ìƒì„±
      const userIdMap: Record<string, string> = {};
      messages.forEach(msg => {
        if (msg.user === 'user-general' && msg.sender?.id) {
          userIdMap[msg.sender.id] = msg.name;
        }
      });
      
      // ê° ì‚¬ìš©ìë³„ ìš•ì„¤ ë ˆë²¨ ì •ë³´ ì¶”ê°€
      Object.entries(userCurseLevels).forEach(([userId, level]) => {
        const username = userIdMap[userId] || 'ì•Œ ìˆ˜ ì—†ëŠ” ì‚¬ìš©ì';
        let severityLabel = '';
        if (level >= 25) {
          severityLabel = '(ê·¹ë„ë¡œ ì‹¬ê°í•œ ìˆ˜ì¤€)';
        } else if (level >= 20) {
          severityLabel = '(ë§¤ìš° ì‹¬ê°í•œ ìˆ˜ì¤€)';
        } else if (level >= 15) {
          severityLabel = '(ì‹¬ê°í•œ ìˆ˜ì¤€)';
        } else if (level >= 10) {
          severityLabel = '(ì¤‘ëŒ€í•œ ìˆ˜ì¤€)';
        } else if (level >= 5) {
          severityLabel = '(ì¤‘ê°„ ìˆ˜ì¤€)';
        } else if (level > 0) {
          severityLabel = '(ê²½ë¯¸í•œ ìˆ˜ì¤€)';
        }
        curseLevelsStr += `${username}: ${level}/30 ${severityLabel}\n`;
      });
    } else {
      curseLevelsStr = 'ëª¨ë“  ì°¸ê°€ìê°€ ì •ì¤‘í•œ ì–¸ì–´ë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.';
    }
    
    // ëŒ€í™” ì´ë ¥ êµ¬ì„±
    const conversationHistory = filteredMessages
      .map(msg => {
        const timestamp = new Date(msg.timestamp).toLocaleTimeString();
        let messagePrefix = '';
        
        // ë©”ì‹œì§€ ìœ í˜• ë° ê´€ë ¨ ìŸì  í‘œì‹œ
        if (msg.messageType === 'evidence') {
          messagePrefix = '[ì¦ê±°] ';
        } else if (msg.messageType === 'objection') {
          messagePrefix = '[ë°˜ë¡ ] ';
        } else if (msg.messageType === 'closing') {
          messagePrefix = '[ìµœì¢…ë³€ë¡ ] ';
        }
        
        if (msg.relatedIssue) {
          messagePrefix += `[ìŸì : ${msg.relatedIssue}] `;
        }
        
        return `${msg.name}(${timestamp}): ${messagePrefix}${msg.text}`;
      })
      .join('\n');
    
    // ì°¸ê°€ì ì •ë³´ ì¶”ì¶œ
    const participants = Array.from(new Set(
      filteredMessages
        .filter(msg => msg.user === 'user-general')
        .map(msg => msg.name)
    ));
    //console.log('ëŒ€í™” ì°¸ê°€ì:', participants);
    
    const prompt = `í•­ìƒ ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”. ì˜ì–´ë¡œ ì‘ë‹µí•˜ë©´ ì•ˆ ë©ë‹ˆë‹¤. ë‹µë³€ì˜ ëª¨ë“  ë¶€ë¶„(JSON í¬í•¨)ì€ í•œêµ­ì–´ë¡œë§Œ ì‘ì„±í•˜ì„¸ìš”.
    
      ë‹¹ì‹ ì€ ê´€ê³„ ê°ˆë“±ì˜ ìµœì¢… íŒê²°ì„ ë‚´ë¦¬ëŠ” ìœ ì¾Œí•˜ê³  ê°œì„± ìˆëŠ” íŒì‚¬ì…ë‹ˆë‹¤. ì¬ë¯¸ìˆëŠ” ì¸í„°ë„· ì»¤ë®¤ë‹ˆí‹° ë§íˆ¬ë¡œ ì°¸ê°€ìë“¤ì˜ ë§íˆ¬ì™€ ì„±í–¥ì„ ë°˜ì˜í•œ ìœ ì¾Œí•œ íŒê²°ì„ ë‚´ë¦¬ì„¸ìš”.
      
      ${issuesStr}
      
      ëŒ€í™” ë‚´ìš©:
      ${conversationHistory}
      
      ëŒ€í™”ì— ì°¸ì—¬í•œ ì‚¬ëŒë“¤: ${participants.join(', ')}
      
      ${curseLevelsStr}
      
      ì°¸ê°€ìë“¤ì˜ ìš•ì„¤ ë ˆë²¨ì€ ìœ„ì— í‘œì‹œëœ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ í‰ê°€í•´ì£¼ì„¸ìš”. ìš•ì„¤ ë ˆë²¨ì´ ë†’ì€ ì°¸ê°€ìëŠ” ì´ì— ëŒ€í•œ ì–¸ê¸‰ì„ í¬í•¨í•´ì£¼ì„¸ìš”. 
      ìš•ì„¤ ë ˆë²¨ì€ 0-30 ì²™ë„ë¡œ, ìš•ì„¤ì´ ë§ê±°ë‚˜ ì‹¬í• ìˆ˜ë¡ ë†’ì€ ì ìˆ˜ê°€ ë§¤ê²¨ì§‘ë‹ˆë‹¤.
      ìš•ì„¤ ë ˆë²¨ì´ 10 ì´ìƒì¸ ê²½ìš° íŠ¹ë³„íˆ ì–¸ê¸‰í•˜ê³ , 20 ì´ìƒì¸ ê²½ìš° ê°•ë ¥í•œ ì£¼ì˜ë¥¼ ì£¼ì„¸ìš”. 
      ê·¸ëŸ¬ë‚˜ íŒê²° ìì²´ì—ëŠ” ì§ì ‘ì ì¸ ìš•ì„¤ ì–¸ê¸‰ì€ í”¼í•˜ê³ , ëŒ€ì‹  "ë¶ˆì¾Œí•œ ì–¸ì–´ ì‚¬ìš©", "ê³µê²©ì  í‘œí˜„", "ë¶€ì ì ˆí•œ ì–´íœ˜ ì„ íƒ"ê³¼ ê°™ì€ ì™„ê³¡í•œ í‘œí˜„ì„ ì‚¬ìš©í•˜ì„¸ìš”.
      
      ì´ì œ ìµœì¢… íŒê²°ì„ ë‚´ë ¤ì£¼ì„¸ìš”. ë‹¤ìŒ ì •ë³´ë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤:
      
      1. ê° ì°¸ê°€ìë³„ ê°œë³„ í”¼ë“œë°± (íƒ€ê²Ÿ ì‚¬ìš©ì, ë¶„ì„, ë©”ì‹œì§€, ìŠ¤íƒ€ì¼, ì ìˆ˜ í¬í•¨)
      2. ìŸì ë³„ íŒê²° (ê° ìŸì ì— ëŒ€í•œ íŒë‹¨ê³¼ ì´ìœ  ì œì‹œ)
      3. ì¢…í•© íŒê²° (ê°ˆë“±ì˜ ìš”ì•½, ê·¼ë³¸ ì›ì¸, ì•ìœ¼ë¡œì˜ ê¶Œê³ ì‚¬í•­)
      
      ì¸í„°ë„· ì»¤ë®¤ë‹ˆí‹° ìŠ¤íƒ€ì¼ì˜ ìœ ë¨¸ëŸ¬ìŠ¤í•˜ê³  ê°•ë ¬í•œ ë§íˆ¬ë¥¼ ì‚¬ìš©í•˜ë˜, íŒê²°ì€ ê³µì •í•˜ê³  ê±´ì„¤ì ì´ì–´ì•¼ í•©ë‹ˆë‹¤.
      ë‹¤ë¥¸ ì±„íŒ… ì•±/SNS ì‚¬ì´íŠ¸ì˜ ì¬ë¯¸ìˆëŠ” ë§íˆ¬ì™€ ë°ˆì„ ìµœëŒ€í•œ í™œìš©í•˜ì„¸ìš”.
      
      ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•˜ì„¸ìš”:
      {
        "responses": [
          {
            "targetUser": "ì°¸ê°€ì1 ì´ë¦„",
            "analysis": "ì°¸ê°€ìì˜ ëŒ€í™” ìŠ¤íƒ€ì¼ê³¼ í–‰ë™ íŒ¨í„´ ë¶„ì„",
            "message": "ì´ ì°¸ê°€ìì—ê²Œ ì „ë‹¬í•  ìœ ì¾Œí•˜ê³  íŠ¹ë³„í•œ ë©”ì‹œì§€",
            "style": "ì´ ì°¸ê°€ìì˜ ìŠ¤íƒ€ì¼ì„ í•œ ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½",
            "percentage": 75, // 0-100 ì ìˆ˜ (ê´€ê³„ì—ì„œì˜ ê¸°ì—¬ë„/íƒœë„ ì ìˆ˜)
            "reasoning": ["ì ìˆ˜ì˜ ì´ìœ 1", "ì ìˆ˜ì˜ ì´ìœ 2"],
            "punishment": "ì¬ë¯¸ìˆëŠ” í˜•ë²Œì´ë‚˜ ê³¼ì œ (ì˜ˆ: '1ì£¼ì¼ ë™ì•ˆ ë§¤ì¼ ì•„ì¹¨ ì¹­ì°¬ 3ê°œ í•˜ê¸°')"
          },
          // ë‹¤ë¥¸ ì°¸ê°€ìë“¤ì— ëŒ€í•œ ì‘ë‹µë„ í¬í•¨
        ],
        "issueJudgements": [
          {
            "issue": "ìŸì 1",
            "judgement": "ì´ ìŸì ì— ëŒ€í•œ íŒê²°",
            "reasoning": "íŒê²°ì˜ ê·¼ê±°ì™€ ì´ìœ "
          }
          // ë‹¤ë¥¸ ìŸì ë“¤ì— ëŒ€í•œ íŒê²°ë„ í¬í•¨
        ],
        "verdict": {
          "summary": "ì „ì²´ ê°ˆë“±ì— ëŒ€í•œ íŒê²° ìš”ì•½ (ìœ ì¾Œí•œ ì¸í„°ë„· ì»¤ë®¤ë‹ˆí‹° ìŠ¤íƒ€ì¼ë¡œ)",
          "conflict_root_cause": "ê°ˆë“±ì˜ ê·¼ë³¸ ì›ì¸",
          "recommendation": "ì•ìœ¼ë¡œì˜ ê´€ê³„ ê°œì„ ì„ ìœ„í•œ ê¶Œê³ ì‚¬í•­"
        }
      }
    `;
    
    //console.log('ìµœì¢… íŒê²° í”„ë¡¬í”„íŠ¸ ìƒì„± ì™„ë£Œ, API ìš”ì²­ ì‹œì‘');
    const result = await model.generateContent(prompt);
    //console.log('ìµœì¢… íŒê²° API ì‘ë‹µ ë°›ìŒ');
    
    // API ì‘ë‹µ ì²˜ë¦¬
    const responseText = result.response.text();
    //console.log('API ì‘ë‹µ ë°›ìŒ, ì‘ë‹µ ê¸¸ì´:', responseText.length);
    
    // JSON ë¶€ë¶„ ì¶”ì¶œ ì‹œë„
    try {
      // ì‘ë‹µì—ì„œ ì‹¤ì œ JSON ë¶€ë¶„ ì¶”ì¶œ
      let cleanedText = responseText;
      
      // ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡ ì œê±°
      cleanedText = cleanedText.replace(/```json\s*([\s\S]*?)\s*```/g, '$1');
      cleanedText = cleanedText.replace(/```\s*([\s\S]*?)\s*```/g, '$1');
      //console.log('ì½”ë“œ ë¸”ë¡ ì œê±° í›„ ì‘ë‹µ ê¸¸ì´:', cleanedText.length);
      
      // ìœ íš¨í•œ JSONì´ ì•„ë‹Œ ê²½ìš°
      if (!cleanedText.trim().startsWith("{")) {
        //console.log('ìœ íš¨í•œ JSON í˜•ì‹ì´ ì•„ë‹˜, JSON ì¶”ì¶œ ì‹œë„ ì¤‘');
        const jsonMatch = cleanedText.match(/(\{[\s\S]*\})/);
        if (jsonMatch && jsonMatch[1]) {
          cleanedText = jsonMatch[1];
          //console.log('JSON ì¶”ì¶œ ì„±ê³µ, ê¸¸ì´:', cleanedText.length);
        } else {
          console.error('JSON ì¶”ì¶œ ì‹¤íŒ¨');
          throw new Error('ìœ íš¨í•œ JSON í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.');
        }
      }
      
      // JSON íŒŒì‹± í›„ ë°˜í™˜
      //console.log('JSON íŒŒì‹± ì‹œë„ ì¤‘');
      const parsedData = JSON.parse(cleanedText) as VerdictData;
      //console.log('JSON íŒŒì‹± ì„±ê³µ:', parsedData.verdict ? 'íŒê²° ìˆìŒ' : 'íŒê²° ì—†ìŒ');
      return parsedData;
    } catch (error) {
      console.error('ìµœì¢… íŒê²° ì‘ë‹µ íŒŒì‹± ì˜¤ë¥˜:', error);
      // ì˜¤ë¥˜ ì‹œ ê¸°ë³¸ ì‘ë‹µ ë°˜í™˜
      return {
        responses: participants.map(name => ({
          targetUser: name,
          analysis: 'ë¶„ì„ ì‹¤íŒ¨',
          message: 'ì˜¤ë¥˜ë¡œ ì¸í•´ ê°œì¸ë³„ í”¼ë“œë°±ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
          style: 'ì•Œ ìˆ˜ ì—†ìŒ',
          percentage: 50,
          reasoning: ['ë¶„ì„ ì˜¤ë¥˜'],
          punishment: 'ì—†ìŒ'
        })),
        verdict: {
          summary: 'íŒê²° ê³¼ì •ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
          conflict_root_cause: 'ë¶„ì„ ì‹¤íŒ¨',
          recommendation: 'ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”.'
        }
      };
    }
  } catch (error) {
    console.error('ìµœì¢… íŒê²° API í˜¸ì¶œ ì˜¤ë¥˜:', error);
    return {
      responses: [],
      verdict: {
        summary: 'íŒê²°ì„ ë‚´ë¦¬ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
        conflict_root_cause: 'ì•Œ ìˆ˜ ì—†ìŒ',
        recommendation: 'ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”.'
      }
    };
  }
};